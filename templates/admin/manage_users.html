{% extends \"admin/admin_base.html\" %}\n\n{% block title %}Admin User Management{% endblock %}\n\n{% block content %}\n<div class=\"container-fluid\">\n    <!-- Page Header -->\n    <div class=\"row mb-4\">\n        <div class=\"col-12\">\n            <div class=\"d-flex justify-content-between align-items-center\">\n                <h1 class=\"h3 mb-0\">üõ°Ô∏è Admin User Management</h1>\n                <div>\n                    <a href=\"{{ url_for('admin.security_audit_log') }}\" class=\"btn btn-outline-secondary\">\n                        <i class=\"fas fa-shield-alt\"></i> Security Audit Log\n                    </a>\n                    <a href=\"{{ url_for('admin.admin_dashboard') }}\" class=\"btn btn-primary\">\n                        <i class=\"fas fa-arrow-left\"></i> Back to Dashboard\n                    </a>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Security Alert -->\n    <div class=\"row mb-4\">\n        <div class=\"col-12\">\n            <div class=\"alert alert-warning border-warning\">\n                <h5 class=\"alert-heading\"><i class=\"fas fa-exclamation-triangle\"></i> Security Notice</h5>\n                <p class=\"mb-2\">Admin privilege management is a critical security operation. All admin changes are:</p>\n                <ul class=\"mb-2\">\n                    <li>üìß <strong>Email notifications</strong> sent to all existing admins</li>\n                    <li>üìù <strong>Audit logged</strong> with IP address and timestamp</li>\n                    <li>üîí <strong>Security validated</strong> to prevent unauthorized escalation</li>\n                </ul>\n                <p class=\"mb-0\"><strong>Only grant admin privileges to trusted users.</strong></p>\n            </div>\n        </div>\n    </div>\n\n    <!-- Statistics Cards -->\n    <div class=\"row mb-4\">\n        <div class=\"col-md-3\">\n            <div class=\"card border-primary\">\n                <div class=\"card-body text-center\">\n                    <h3 class=\"text-primary\">{{ stats.total_users }}</h3>\n                    <p class=\"card-text\">Total Users</p>\n                </div>\n            </div>\n        </div>\n        <div class=\"col-md-3\">\n            <div class=\"card border-danger\">\n                <div class=\"card-body text-center\">\n                    <h3 class=\"text-danger\">{{ stats.admin_users }}</h3>\n                    <p class=\"card-text\">Admin Users</p>\n                </div>\n            </div>\n        </div>\n        <div class=\"col-md-3\">\n            <div class=\"card border-success\">\n                <div class=\"card-body text-center\">\n                    <h3 class=\"text-success\">{{ stats.active_users }}</h3>\n                    <p class=\"card-text\">Active Users</p>\n                </div>\n            </div>\n        </div>\n        <div class=\"col-md-3\">\n            <div class=\"card border-secondary\">\n                <div class=\"card-body text-center\">\n                    <h3 class=\"text-secondary\">{{ stats.inactive_users }}</h3>\n                    <p class=\"card-text\">Inactive Users</p>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Users Table -->\n    <div class=\"row\">\n        <div class=\"col-12\">\n            <div class=\"card\">\n                <div class=\"card-header\">\n                    <h5 class=\"card-title mb-0\">üë• All Users</h5>\n                </div>\n                <div class=\"card-body\">\n                    <div class=\"table-responsive\">\n                        <table class=\"table table-striped table-hover\">\n                            <thead class=\"table-dark\">\n                                <tr>\n                                    <th>ID</th>\n                                    <th>Username</th>\n                                    <th>Email</th>\n                                    <th>Full Name</th>\n                                    <th>Status</th>\n                                    <th>Admin</th>\n                                    <th>Created</th>\n                                    <th>Last Login</th>\n                                    <th>Actions</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                {% for user in users %}\n                                <tr class=\"{% if user.is_admin %}table-warning{% endif %}\">\n                                    <td>{{ user.id }}</td>\n                                    <td>\n                                        <strong>{{ user.username }}</strong>\n                                        {% if user.id == current_user.id %}\n                                        <span class=\"badge bg-info ms-1\">You</span>\n                                        {% endif %}\n                                    </td>\n                                    <td>{{ user.email }}</td>\n                                    <td>{{ user.full_name or '-' }}</td>\n                                    <td>\n                                        {% if user.is_active %}\n                                        <span class=\"badge bg-success\">Active</span>\n                                        {% else %}\n                                        <span class=\"badge bg-secondary\">Inactive</span>\n                                        {% endif %}\n                                        \n                                        {% if user.is_verified %}\n                                        <span class=\"badge bg-primary\">Verified</span>\n                                        {% endif %}\n                                    </td>\n                                    <td>\n                                        {% if user.is_admin %}\n                                        <span class=\"badge bg-danger\">üõ°Ô∏è Admin</span>\n                                        {% else %}\n                                        <span class=\"badge bg-light text-dark\">User</span>\n                                        {% endif %}\n                                    </td>\n                                    <td>\n                                        <small>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '-' }}</small>\n                                    </td>\n                                    <td>\n                                        <small>{{ user.last_login.strftime('%Y-%m-%d %H:%M') if user.last_login else 'Never' }}</small>\n                                    </td>\n                                    <td>\n                                        {% if user.id != current_user.id %}\n                                            {% if user.is_admin %}\n                                            <!-- Revoke Admin Button -->\n                                            <form method=\"POST\" action=\"{{ url_for('admin.revoke_admin_privileges', user_id=user.id) }}\" \n                                                  class=\"d-inline\" \n                                                  onsubmit=\"return confirm('Are you sure you want to REVOKE admin privileges from {{ user.username }}?\\n\\nThis action will:\\n- Remove all admin access\\n- Send email notifications to all admins\\n- Be logged in the security audit trail')\">\n                                                <button type=\"submit\" class=\"btn btn-sm btn-outline-danger\">\n                                                    <i class=\"fas fa-user-minus\"></i> Revoke Admin\n                                                </button>\n                                            </form>\n                                            {% else %}\n                                            <!-- Grant Admin Button -->\n                                            <form method=\"POST\" action=\"{{ url_for('admin.grant_admin_privileges', user_id=user.id) }}\" \n                                                  class=\"d-inline\" \n                                                  onsubmit=\"return confirm('Are you sure you want to GRANT admin privileges to {{ user.username }}?\\n\\nThis action will:\\n- Give full admin access\\n- Send email alerts to all existing admins\\n- Be permanently logged for security audit\\n\\nOnly proceed if you trust this user completely.')\">\n                                                <button type=\"submit\" class=\"btn btn-sm btn-outline-warning\">\n                                                    <i class=\"fas fa-user-shield\"></i> Grant Admin\n                                                </button>\n                                            </form>\n                                            {% endif %}\n                                        {% else %}\n                                        <small class=\"text-muted\">Cannot modify own privileges</small>\n                                        {% endif %}\n                                    </td>\n                                </tr>\n                                {% endfor %}\n                            </tbody>\n                        </table>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Recent Admin Activity -->\n    {% if recent_logs %}\n    <div class=\"row mt-4\">\n        <div class=\"col-12\">\n            <div class=\"card\">\n                <div class=\"card-header\">\n                    <h5 class=\"card-title mb-0\">üìã Recent Admin Activity (Last 50 entries)</h5>\n                </div>\n                <div class=\"card-body\">\n                    <div class=\"table-responsive\">\n                        <table class=\"table table-sm\">\n                            <thead>\n                                <tr>\n                                    <th>Timestamp</th>\n                                    <th>Action</th>\n                                    <th>Target User</th>\n                                    <th>Admin</th>\n                                    <th>IP Address</th>\n                                </tr>\n                            </thead>\n                            <tbody>\n                                {% for log in recent_logs %}\n                                <tr>\n                                    <td><small>{{ log.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small></td>\n                                    <td>\n                                        {% if log.action == 'grant_admin' %}\n                                        <span class=\"badge bg-warning\">üõ°Ô∏è Admin Granted</span>\n                                        {% elif log.action == 'revoke_admin' %}\n                                        <span class=\"badge bg-danger\">‚ùå Admin Revoked</span>\n                                        {% elif log.action == 'admin_login_success' %}\n                                        <span class=\"badge bg-success\">‚úÖ Admin Login</span>\n                                        {% elif log.action == 'admin_login_failure' %}\n                                        <span class=\"badge bg-danger\">‚ùå Login Failed</span>\n                                        {% else %}\n                                        <span class=\"badge bg-secondary\">{{ log.action }}</span>\n                                        {% endif %}\n                                    </td>\n                                    <td>{{ log.target_user.username if log.target_user else 'Unknown' }}</td>\n                                    <td>{{ log.admin_user.username if log.admin_user else 'System' }}</td>\n                                    <td><small><code>{{ log.ip_address or '-' }}</code></small></td>\n                                </tr>\n                                {% endfor %}\n                            </tbody>\n                        </table>\n                    </div>\n                    <div class=\"text-center mt-3\">\n                        <a href=\"{{ url_for('admin.security_audit_log') }}\" class=\"btn btn-outline-primary\">\n                            <i class=\"fas fa-shield-alt\"></i> View Full Security Audit Log\n                        </a>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n    {% endif %}\n</div>\n{% endblock %}\n\n{% block extra_js %}\n<script>\n    // Auto-refresh page every 5 minutes to show latest activity\n    setTimeout(function() {\n        location.reload();\n    }, 300000);\n</script>\n{% endblock %}\n