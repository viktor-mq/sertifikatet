<style>
.column-value-filter {
    position: absolute;
    top: calc(100% - 25px);
    left: 0;
    width: 200px; /* Fixed width for dropdowns */
    max-width: 300px;
    padding: 2px;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 12px;
    background: white;
    z-index: 1000;
}

th {
    position: relative;
    min-width: 100px;
    white-space: nowrap;
    padding-bottom: 45px; /* Space for dropdown */
}

/* Handle long text in dropdowns */
.column-value-filter option {
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.table-container {
    position: relative;
    margin-top: 10px; /* Add space above table */
}
</style>

<div id="databaseSection" class="section" style="margin-top: 30px;">
    
    <!-- Database Statistics -->
    <div class="stats-container" style="margin-bottom: 30px;">
        <div class="stat-card">
            <h3>{{ tables|length }}</h3>
            <p>Totale tabeller</p>
        </div>
        <div class="stat-card">
            <h3>{{ stats.total }}</h3>
            <p>Totale sp√∏rsm√•l</p>
        </div>
        <div class="stat-card">
            <h3>{{ images|length }}</h3>
            <p>Tilgjengelige bilder</p>
        </div>
    </div>
    
    {% if message %}
        <div class="message" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
            {{ message }}
        </div>
    {% endif %}
    
    <form method="POST" action="{{ url_for('admin.admin_dashboard') }}" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h3 style="margin-top: 0;">üíª SQL-konsoll</h3>
        <textarea id="sql_query" name="sql_query" rows="5" style="width:100%; box-sizing:border-box; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px; font-family: 'Courier New', monospace;"></textarea>
        <button type="submit" class="btn" style="margin-top: 10px;">‚ñ∂Ô∏è Kj√∏r SQL</button>
    </form>

    <!-- Enhanced Database Filters -->
    <form id="database-filter-form" class="enhanced-filter-form">
        <div class="search-filter-container enhanced-search">
            <input type="text" id="database-search" name="search" placeholder="üîç Search across tables..." class="search-input" />
            <select id="tableFilter" name="table" onchange="filterTables()">
                <option value="all">Alle tabeller</option>
                {% for table in tables.keys() %}
                    <option value="{{ table }}">{{ table }}</option>
                {% endfor %}
            </select>
            <select name="per_page" id="database-per-page">
                <option value="50">50 per page</option>
                <option value="100">100 per page</option>
                <option value="200">200 per page</option>
            </select>
            <button type="button" class="btn" onclick="performDatabaseSearch()">üîç Search</button>
            <button type="button" class="btn btn-secondary" onclick="clearDatabaseFilters()">üóëÔ∏è Clear</button>
            <div class="loading-indicator" id="database-loading" style="display: none;">‚è≥ Loading...</div>
        </div>
    </form>

    {% for table, rows in tables.items() %}
        <div class="table-section" data-table="{{ table }}" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
            <h3 style="color: #374151; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                 {{ table|upper|replace('_', ' ') }}
            </h3>
            
            {% if rows %}
                <!-- Column Filter -->
                <div class="column-filter" style="margin-bottom: 10px;">
                    {% for col in rows[0].keys() %}
                        <label style="margin-right: 10px;">
                            <input type="checkbox" 
                                   class="column-checkbox" 
                                   data-table="{{ table }}" 
                                   data-column="{{ col }}" 
                                   checked> {{ col }}
                        </label>
                    {% endfor %}
                </div>

                <div class="table-container">
                    <div id="{{ table }}-results-info" class="results-info"></div>
                    <table id="{{ table }}-table" class="database-table">
                        <thead>
                            <tr>
                                {% for col in rows[0].keys() %}
                                <th class="sortable" data-column="{{ col }}" data-table="{{ table }}" onclick="sortTable('{{ table }}', '{{ col }}')">
                                    {{ col }} <span class="sort-indicator"></span>
                                    <select class="column-value-filter" data-table="{{ table }}" data-column="{{ col }}" onchange="filterTableByColumn()">
                                        <option value="all">Alle</option>
                                        {% set unique_values = [] %}
                                        {% for row in rows %}
                                            {% if row[col] not in unique_values %}
                                                {% set _ = unique_values.append(row[col]) %}
                                                <option value="{{ row[col] }}">{{ row[col] }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in rows %}
                                <tr>
                                    {% for col in rows[0].keys() %}
                                        <td data-column="{{ col }}" style="color: black;">
                                            {% if table == 'traffic_signs' and col == 'filename' %}
                                                {% set matching = images | selectattr('filename', 'equalto', row[col]) | list %}
                                                {% if matching %}
                                                    {% set current_folder = matching[0].folder %}
                                                {% else %}
                                                    {% set current_folder = '' %}
                                                {% endif %}
                                                <img src="{{ url_for('static',
                                                    filename=( 'images/' ~ current_folder ~ '/' ~ row[col] )
                                                             if current_folder
                                                             else 'images/' ~ row[col]
                                                ) }}"
                                                     alt="{{ row[col] }}"
                                                     style="max-width: 100px;">
                                            {% else %}
                                                {{ row[col] }}
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>(Ingen data i denne tabellen.)</p>
            {% endif %}
        </div>
        <!-- Pagination Controls -->
        <div id="{{ table }}-pagination" class="pagination-container"></div>
    {% endfor %}
    
    <!-- Global Database Pagination -->
    <div id="database-pagination" class="pagination-container"></div>
</div>

<!-- Enhanced CSS for Database Section -->
<style>
/* Reuse enhanced styles from other sections */
.enhanced-filter-form {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.enhanced-search {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.search-input {
  flex: 1;
  min-width: 300px;
  padding: 8px 12px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 14px;
}

.search-input:focus {
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.sortable {
  cursor: pointer;
  user-select: none;
  position: relative;
}

.sortable:hover {
  background-color: rgba(59, 130, 246, 0.1);
}

.sort-indicator {
  margin-left: 5px;
  opacity: 0.5;
}

.sort-indicator.asc::after {
  content: '‚Üë';
  color: #10b981;
}

.sort-indicator.desc::after {
  content: '‚Üì';
  color: #ef4444;
}

.results-info {
  margin-bottom: 10px;
  padding: 8px 12px;
  background: #f3f4f6;
  border-radius: 6px;
  font-size: 14px;
  color: #374151;
}

.loading-indicator {
  color: white;
  font-weight: bold;
}

.pagination-container {
  margin-top: 20px;
  text-align: center;
}

.pagination {
  display: inline-flex;
  gap: 5px;
  align-items: center;
}

.page-btn {
  padding: 8px 12px;
  border: 1px solid #d1d5db;
  background: white;
  color: #374151;
  border-radius: 6px;
  cursor: pointer;
  text-decoration: none;
}

.page-btn:hover {
  background: #f3f4f6;
}

.page-btn.active {
  background: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.page-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.database-table {
  margin-bottom: 10px;
}

@media (max-width: 768px) {
  .enhanced-search {
    flex-direction: column;
    align-items: stretch;
  }
  
  .search-input {
    min-width: unset;
  }
}
</style>

<!-- Include admin-base.js -->
<script src="{{ url_for('static', filename='js/admin-base.js') }}"></script>

<script>
// Database Section Enhancement JavaScript
let currentDatabaseFilters = {};
let currentDatabaseSort = {};
let currentDatabasePage = {};
let databasePerPage = 50;
let currentTable = 'all';

document.addEventListener('DOMContentLoaded', function() {
    // Only initialize if database section exists and is visible
    const databaseSection = document.getElementById('databaseSection');
    if (databaseSection && databaseSection.offsetParent !== null) {
        initializeDatabaseEnhancements();
    }
});

function initializeDatabaseEnhancements() {
    // Initialize search with debouncing
    const searchInput = document.getElementById('database-search');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performDatabaseSearch();
            }, 300);
        });
    }
    
    // Initialize per-page selector
    const perPageSelect = document.getElementById('database-per-page');
    if (perPageSelect) {
        perPageSelect.addEventListener('change', function() {
            databasePerPage = parseInt(this.value);
            performDatabaseSearch();
        });
    }
    
    // Initialize table filter
    const tableFilter = document.getElementById('tableFilter');
    if (tableFilter) {
        tableFilter.addEventListener('change', function() {
            currentTable = this.value;
            filterTables();
        });
    }
    
    // Initialize column checkboxes
    document.querySelectorAll('.column-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const table = this.dataset.table;
            const column = this.dataset.column;
            const cells = document.querySelectorAll(`.table-section[data-table="${table}"] td[data-column="${column}"]`);
            
            cells.forEach(cell => {
                cell.style.display = this.checked ? '' : 'none';
            });
            
            // Also toggle header
            const header = document.querySelector(`.table-section[data-table="${table}"] th[data-column="${column}"]`);
            if (header) {
                header.style.display = this.checked ? '' : 'none';
            }
        });
    });
    
    // Initialize keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key) {
                case 'd':
                    e.preventDefault();
                    document.getElementById('database-search').focus();
                    break;
            }
        }
    });
}

function performDatabaseSearch() {
    const form = document.getElementById('database-filter-form');
    const formData = new FormData(form);
    
    const searchTerm = formData.get('search') || '';
    
    if (searchTerm.length > 0) {
        searchAcrossTables(searchTerm);
    } else {
        // Reset all tables if no search term
        document.querySelectorAll('.table-section tbody tr').forEach(row => {
            row.style.display = '';
        });
        updateAllResultsInfo();
    }
}

function searchAcrossTables(searchTerm) {
    setDatabaseLoading(true);
    
    const searchLower = searchTerm.toLowerCase();
    let totalMatches = 0;
    
    document.querySelectorAll('.table-section').forEach(tableSection => {
        const tableName = tableSection.dataset.table;
        const rows = tableSection.querySelectorAll('tbody tr');
        let tableMatches = 0;
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            let hasMatch = false;
            
            cells.forEach(cell => {
                if (cell.textContent.toLowerCase().includes(searchLower)) {
                    hasMatch = true;
                }
            });
            
            if (hasMatch) {
                row.style.display = '';
                tableMatches++;
                totalMatches++;
                // Highlight matching text
                highlightText(row, searchTerm);
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update results info for this table
        updateTableResultsInfo(tableName, tableMatches, rows.length);
    });
    
    AdminEnhancements.showToast(`Found ${totalMatches} matches across all tables`, 'success');
    setDatabaseLoading(false);
}

function highlightText(row, searchTerm) {
    const cells = row.querySelectorAll('td');
    const searchLower = searchTerm.toLowerCase();
    
    cells.forEach(cell => {
        const text = cell.textContent;
        const textLower = text.toLowerCase();
        
        if (textLower.includes(searchLower)) {
            const startIndex = textLower.indexOf(searchLower);
            const endIndex = startIndex + searchTerm.length;
            
            const beforeMatch = text.substring(0, startIndex);
            const match = text.substring(startIndex, endIndex);
            const afterMatch = text.substring(endIndex);
            
            cell.innerHTML = `${beforeMatch}<mark style="background: yellow; padding: 2px;">${match}</mark>${afterMatch}`;
        }
    });
}

function updateTableResultsInfo(tableName, matches, total) {
    const infoDiv = document.getElementById(`${tableName}-results-info`);
    if (!infoDiv) return;
    
    if (matches < total) {
        infoDiv.innerHTML = `Showing ${matches} of ${total} rows`;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

function updateAllResultsInfo() {
    document.querySelectorAll('.results-info').forEach(info => {
        info.style.display = 'none';
    });
}

function sortTable(tableName, column) {
    const tableSection = document.querySelector(`.table-section[data-table="${tableName}"]`);
    if (!tableSection) return;
    
    const tbody = tableSection.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const header = tableSection.querySelector(`th[data-column="${column}"]`);
    
    // Determine sort direction
    let currentOrder = currentDatabaseSort[tableName]?.[column] || 'none';
    let newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
    
    // Initialize sort state for table if not exists
    if (!currentDatabaseSort[tableName]) {
        currentDatabaseSort[tableName] = {};
    }
    
    // Clear other column sorts for this table
    Object.keys(currentDatabaseSort[tableName]).forEach(col => {
        if (col !== column) {
            delete currentDatabaseSort[tableName][col];
        }
    });
    
    currentDatabaseSort[tableName][column] = newOrder;
    
    // Get column index
    const headers = Array.from(tableSection.querySelectorAll('th'));
    const columnIndex = headers.findIndex(h => h.dataset.column === column);
    
    // Sort rows
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex]?.textContent?.trim() || '';
        const bValue = b.cells[columnIndex]?.textContent?.trim() || '';
        
        // Try to parse as numbers if possible
        const aNum = parseFloat(aValue);
        const bNum = parseFloat(bValue);
        
        let comparison = 0;
        if (!isNaN(aNum) && !isNaN(bNum)) {
            comparison = aNum - bNum;
        } else {
            comparison = aValue.localeCompare(bValue);
        }
        
        return newOrder === 'asc' ? comparison : -comparison;
    });
    
    // Clear tbody and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    // Update sort indicators
    updateDatabaseSortIndicators(tableName);
    
    AdminEnhancements.showToast(`Sorted ${tableName} by ${column} (${newOrder})`, 'success');
}

function updateDatabaseSortIndicators(tableName) {
    const tableSection = document.querySelector(`.table-section[data-table="${tableName}"]`);
    if (!tableSection) return;
    
    // Clear all indicators for this table
    tableSection.querySelectorAll('.sort-indicator').forEach(indicator => {
        indicator.className = 'sort-indicator';
    });
    
    // Set active indicator
    if (currentDatabaseSort[tableName]) {
        Object.entries(currentDatabaseSort[tableName]).forEach(([column, order]) => {
            const indicator = tableSection.querySelector(`th[data-column="${column}"] .sort-indicator`);
            if (indicator) {
                indicator.className = `sort-indicator ${order}`;
            }
        });
    }
}

function filterTables() {
    const selectedTable = document.getElementById('tableFilter').value;
    const tables = document.querySelectorAll('.table-section');
    
    tables.forEach(table => {
        if (selectedTable === 'all' || table.dataset.table === selectedTable) {
            table.style.display = 'block';
        } else {
            table.style.display = 'none';
        }
    });
    
    // Update current table
    currentTable = selectedTable;
    
    // Clear search if table changed
    const searchInput = document.getElementById('database-search');
    if (searchInput && searchInput.value) {
        performDatabaseSearch();
    }
}

function filterTableByColumn() {
    const tables = document.querySelectorAll('.table-section');
    
    tables.forEach(table => {
        const rows = table.querySelectorAll('tbody tr');
        const filters = table.querySelectorAll('.column-value-filter');
        
        rows.forEach(row => {
            let showRow = true;
            
            filters.forEach(filter => {
                const column = filter.dataset.column;
                const filterValue = filter.value;
                const cell = row.querySelector(`td[data-column="${column}"]`);
                
                if (filterValue !== 'all' && cell && cell.textContent.trim() !== filterValue) {
                    showRow = false;
                }
            });
            
            row.style.display = showRow ? '' : 'none';
        });
        
        // Update results info for filtered table
        const tableName = table.dataset.table;
        const visibleRows = table.querySelectorAll('tbody tr[style=""], tbody tr:not([style])').length;
        const totalRows = table.querySelectorAll('tbody tr').length;
        updateTableResultsInfo(tableName, visibleRows, totalRows);
    });
}

function clearDatabaseFilters() {
    // Clear search input
    document.getElementById('database-search').value = '';
    
    // Clear table filter
    document.getElementById('tableFilter').value = 'all';
    
    // Clear column filters
    document.querySelectorAll('.column-value-filter').forEach(filter => {
        filter.value = 'all';
    });
    
    // Reset column checkboxes
    document.querySelectorAll('.column-checkbox').forEach(checkbox => {
        checkbox.checked = true;
        checkbox.dispatchEvent(new Event('change'));
    });
    
    // Clear sorting
    currentDatabaseSort = {};
    document.querySelectorAll('.sort-indicator').forEach(indicator => {
        indicator.className = 'sort-indicator';
    });
    
    // Show all tables and rows
    filterTables();
    filterTableByColumn();
    
    // Clear highlights
    document.querySelectorAll('mark').forEach(mark => {
        mark.replaceWith(mark.textContent);
    });
    
    // Hide results info
    updateAllResultsInfo();
    
    AdminEnhancements.showToast('Database filters cleared', 'success');
}

function setDatabaseLoading(loading) {
    const indicator = document.getElementById('database-loading');
    const tables = document.querySelectorAll('.database-table');
    
    if (indicator) {
        indicator.style.display = loading ? 'inline' : 'none';
    }
    tables.forEach(table => {
        table.style.opacity = loading ? '0.6' : '1';
    });
}

// Enhanced export functionality
function exportTableData(tableName, format = 'csv') {
    const table = document.querySelector(`.table-section[data-table="${tableName}"] table`);
    if (!table) return;
    
    const rows = Array.from(table.querySelectorAll('tr:not([style*="display: none"])'));
    
    if (format === 'csv') {
        exportToCSV(rows, tableName);
    } else if (format === 'json') {
        exportToJSON(rows, tableName);
    }
}

function exportToCSV(rows, tableName) {
    const csvContent = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => {
            let content = cell.textContent.trim();
            // Escape quotes and wrap in quotes if contains comma
            if (content.includes(',') || content.includes('"')) {
                content = '"' + content.replace(/"/g, '""') + '"';
            }
            return content;
        }).join(',');
    }).join('\\n');
    
    downloadFile(csvContent, `${tableName}_export.csv`, 'text/csv');
}

function exportToJSON(rows, tableName) {
    const headers = Array.from(rows[0].querySelectorAll('th')).map(th => th.textContent.trim());
    const data = [];
    
    for (let i = 1; i < rows.length; i++) {
        const cells = Array.from(rows[i].querySelectorAll('td'));
        const rowData = {};
        
        cells.forEach((cell, index) => {
            rowData[headers[index]] = cell.textContent.trim();
        });
        
        data.push(rowData);
    }
    
    downloadFile(JSON.stringify(data, null, 2), `${tableName}_export.json`, 'application/json');
}

function downloadFile(content, fileName, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.click();
    URL.revokeObjectURL(url);
    
    AdminEnhancements.showToast(`Exported ${fileName}`, 'success');
}
</script>