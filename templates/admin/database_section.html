<style>
.column-value-filter {
    position: absolute;
    top: calc(100% - 25px);
    left: 0;
    width: 200px; /* Fixed width for dropdowns */
    max-width: 300px;
    padding: 2px;
    border: 1px solid #ddd;
    border-radius: 3px;
    font-size: 12px;
    background: white;
    z-index: 1000;
}

th {
    position: relative;
    min-width: 100px;
    white-space: nowrap;
    padding-bottom: 45px; /* Space for dropdown */
}

/* Handle long text in dropdowns */
.column-value-filter option {
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
.table-container {
    position: relative;
    margin-top: 10px; /* Add space above table */
}
</style>

<div id="databaseSection" style="display:none; margin-top:20px;">
    {% if message %}
        <div class="message">{{ message }}</div>
    {% endif %}
    
    <form method="POST">
        <label for="sql_query">SQL-konsoll:</label>
        <textarea id="sql_query" name="sql_query" rows="5" style="width:100%; box-sizing:border-box;"></textarea>
        <button type="submit" class="btn">Kj√∏r SQL</button>
    </form>

    <!-- Table Filter -->
    <div style="margin: 20px 0;">
        <label for="tableFilter" style="font-size: 22px; font-weight: bold;">Vis tabell: </label>
        <select id="tableFilter" onchange="filterTables()">
            <option value="all">Alle tabeller</option>
            {% for table in tables.keys() %}
                <option value="{{ table }}">{{ table }}</option>
            {% endfor %}
        </select>
    </div>

    {% for table, rows in tables.items() %}
        <div class="table-section" data-table="{{ table }}">
            <h2 style="margin-top:30px;">Tabell: {{ table }}</h2>
            
            {% if rows %}
                <!-- Column Filter -->
                <div class="column-filter" style="margin-bottom: 10px;">
                    {% for col in rows[0].keys() %}
                        <label style="margin-right: 10px;">
                            <input type="checkbox" 
                                   class="column-checkbox" 
                                   data-table="{{ table }}" 
                                   data-column="{{ col }}" 
                                   checked> {{ col }}
                        </label>
                    {% endfor %}
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                {% for col in rows[0].keys() %}
                                <th data-column="{{ col }}">
                                    {{ col }}
                                    <select class="column-value-filter" data-table="{{ table }}" data-column="{{ col }}" onchange="filterTableByColumn()">
                                        <option value="all">Alle</option>
                                        {% set unique_values = [] %}
                                        {% for row in rows %}
                                            {% if row[col] not in unique_values %}
                                                {% set _ = unique_values.append(row[col]) %}
                                                <option value="{{ row[col] }}">{{ row[col] }}</option>
                                            {% endif %}
                                        {% endfor %}
                                    </select>
                                </th>
                            {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in rows %}
                                <tr>
                                    {% for col in rows[0].keys()%}
                                        <td data-column="{{ col }}" style="color: black;">
                                            {% if table == 'traffic_signs' and col == 'filename' %}
                                                <img src="{{ url_for('static', filename='images/signs/' ~ row[col]) }}" 
                                                     alt="{{ row[col] }}" 
                                                     style="max-width: 100px;">
                                            {% else %}
                                                {{ row[col] }}
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p>(Ingen data i denne tabellen.)</p>
            {% endif %}
        </div>
    {% endfor %}
</div>

<script>
function filterTables() {
    const selectedTable = document.getElementById('tableFilter').value;
    const tables = document.querySelectorAll('.table-section');
    
    tables.forEach(table => {
        if (selectedTable === 'all' || table.dataset.table === selectedTable) {
            table.style.display = 'block';
        } else {
            table.style.display = 'none';
        }
    });
}

document.querySelectorAll('.column-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const table = this.dataset.table;
        const column = this.dataset.column;
        const cells = document.querySelectorAll(`[data-table="${table}"] [data-column="${column}"]`);
        
        cells.forEach(cell => {
            cell.style.display = this.checked ? '' : 'none';
        });
    });
});
</script>

<script>
function filterTableByColumn() {
    const tables = document.querySelectorAll('.table-section');
    
    tables.forEach(table => {
        const rows = table.querySelectorAll('tbody tr');
        const filters = table.querySelectorAll('.column-value-filter');
        
        rows.forEach(row => {
            let showRow = true;
            
            filters.forEach(filter => {
                const column = filter.dataset.column;
                const filterValue = filter.value;
                const cell = row.querySelector(`td[data-column="${column}"]`);
                
                if (filterValue !== 'all' && cell.textContent.trim() !== filterValue) {
                    showRow = false;
                }
            });
            
            row.style.display = showRow ? '' : 'none';
        });
    });
}
</script>

  <script>
    function showSection(section) {
      var questionsSection = document.getElementById('questionsSection');
      var databaseSection = document.getElementById('databaseSection');
      if (section === 'questions') {
        questionsSection.style.display = 'block';
        databaseSection.style.display = 'none';
      } else if (section === 'database') {
        questionsSection.style.display = 'none';
        databaseSection.style.display = 'block';
      }
    }
  </script>
</body>
</html>