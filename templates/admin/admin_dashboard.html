<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Adminpanel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 40px;
            background-color: #f4f4f4;
        }

        h1 {
            color: #333;
        }
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-width: 1400px;
            width: 95%;
            margin: auto;
        }
        .btn {
            padding: 10px 20px;
            background-color: #0077cc;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin-right: 10px;
            border: none;
            cursor: pointer;
            display: inline-block;
        }
        .btn:hover {
            background-color: #005fa3;
        }
        .btn.active {
            background-color: #005fa3;
            border: 2px solid #ffffff;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover {
            background-color: #e0a800;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            margin: 2px;
        }
        .table-container {
            overflow-x: auto;
            position: relative;
            margin-top: 10px;
        }
        #questionForm label,
        #questionForm textarea,
        #questionForm input,
        #questionForm select,
        #questionForm button {
            display: block;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #0077cc;
            color: white;
            position: relative;
            min-width: 100px;
            white-space: nowrap;
            padding-bottom: 45px;
        }
        .column-filter {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .column-filter label {
            display: inline-block;
            margin: 5px;
            cursor: pointer;
        }
        #tableFilter {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        /* Search and Filter Styles */
        .search-filter-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-filter-container input,
        .search-filter-container select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .search-filter-container input[type="text"] {
            min-width: 300px;
        }
        /* Statistics Styles */
        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 2em;
        }
        .stat-card p {
            margin: 0;
            opacity: 0.9;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        /* Preview Styles */
        .preview-question {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #0077cc;
        }
        .preview-options {
            margin-top: 15px;
        }
        .preview-option {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .preview-option.correct {
            background: #d4edda;
            border-color: #28a745;
        }
        /* Bulk operations */
        .bulk-operations {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ffeaa7;
        }
        /* Validation errors */
        .validation-errors {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        .validation-errors ul {
            margin: 0;
            padding-left: 20px;
        }
        /* Checkbox column */
        .checkbox-column {
            width: 30px;
            text-align: center;
        }
        /* Section styles */
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        /* Database section styles */
        .database-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .database-info {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .database-info h3 {
            margin-top: 0;
        }
        /* SQL Console Styles */
        .sql-console {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #dee2e6;
        }
        .sql-console textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }
        .sql-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }
        /* Table Section Styles */
        .table-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .table-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .table-section h3::before {
            content: "üìä";
        }
        /* Column Value Filter */
        .column-value-filter {
            position: absolute;
            top: calc(100% - 35px);
            left: 0;
            width: 90%;
            max-width: 200px;
            padding: 4px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            background: white;
            z-index: 100;
        }
        .column-value-filter option {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        /* Edit form styles */
        .edit-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #0077cc;
            margin-top: 10px;
        }
        .edit-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .edit-form input,
        .edit-form textarea,
        .edit-form select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .options-display {
            font-size: 0.9em;
            color: #555;
        }
        .correct-answer {
            font-weight: bold;
            color: #28a745;
        }
        .question-image {
            max-width: 100px;
            height: auto;
            border-radius: 4px;
        }
        /* Database Stats Cards */
        .db-stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .db-stat-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 200px;
            flex: 1;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .db-stat-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.8em;
        }
        .db-stat-card p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
        /* Message styles */
        .message {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        /* Table Filter Bar */
        .table-filter-bar {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .table-filter-bar label {
            font-weight: bold;
            font-size: 16px;
        }
        .table-filter-bar select {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Velkommen til adminpanelet</h1>
        <p>Her kan du administrere sp√∏rsm√•l og tilknyttede skiltbilder.</p>

        <a href="#" class="btn active" onclick="showSection('questions')" id="questionsTab">üìã Sp√∏rsm√•l</a>
        <a href="#" class="btn" onclick="showSection('database')" id="databaseTab">üíæ Database</a>

        <!-- Questions Section -->
        <div id="questionsSection" class="section active" style="margin-top: 30px;">
            <!-- Statistics Section -->
            <div class="stats-container">
                <div class="stat-card">
                    <h3 id="totalQuestions">{{ stats.total }}</h3>
                    <p>Totale sp√∏rsm√•l</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalCategories">{{ stats.by_category|length }}</h3>
                    <p>Kategorier</p>
                </div>
                <div class="stat-card">
                    <h3 id="questionsWithImages">{{ stats.with_images }}</h3>
                    <p>Med bilder</p>
                </div>
                <div class="stat-card">
                    <h3 id="questionsWithoutImages">{{ stats.without_images }}</h3>
                    <p>Uten bilder</p>
                </div>
            </div>

            <!-- Validation Errors -->
            {% if validation_errors %}
            <div class="validation-errors">
                <strong>‚ö†Ô∏è Feil i skjemaet:</strong>
                <ul>
                    {% for error in validation_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div style="margin-bottom: 20px;">
                <a href="#" onclick="toggleForm()" class="btn">‚ûï Legg til nytt sp√∏rsm√•l</a>
                <a href="{{ url_for('export_questions') }}" class="btn btn-success">üì• Eksporter sp√∏rsm√•l</a>
                <button onclick="toggleBulkMode()" class="btn btn-warning" id="bulkModeBtn">‚úÖ Bulk-operasjoner</button>
            </div>

            <!-- Search and Filter -->
            <form method="GET" action="{{ url_for('admin_dashboard') }}">
                <div class="search-filter-container">
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap; width: 100%;">
                        <input type="text" id="searchInput" name="search" placeholder="üîç S√∏k i sp√∏rsm√•l..." 
                               style="flex: 1; min-width: 300px;" value="{{ search_query }}">
                        
                        <select id="categoryFilter" name="category" style="min-width: 150px;">
                            <option value="">Alle kategorier</option>
                            {% for category in categories %}
                            <option value="{{ category }}" {% if category == category_filter %}selected{% endif %}>
                                {{ category }}
                            </option>
                            {% endfor %}
                        </select>
                        
                        <button type="submit" class="btn">S√∏k</button>
                        <a href="{{ url_for('admin_dashboard') }}" class="btn" style="background-color: #6c757d;">Tilbakestill</a>
                    </div>
                </div>
            </form>

            <!-- Bulk Operations Panel -->
            <form method="POST" action="{{ url_for('bulk_delete') }}" id="bulkForm">
                <div id="bulkOperations" class="bulk-operations" style="display: none;">
                    <p><strong>Bulk-operasjoner:</strong> Velg sp√∏rsm√•l nedenfor og bruk knappene her.</p>
                    <button type="submit" onclick="return confirmBulkDelete()" class="btn btn-danger btn-small">üóëÔ∏è Slett valgte</button>
                    <button type="button" onclick="selectAllQuestions()" class="btn btn-small">‚òëÔ∏è Velg alle</button>
                    <button type="button" onclick="deselectAllQuestions()" class="btn btn-small">‚òê Fjern alle</button>
                    <span id="selectedCount" style="margin-left: 15px; font-weight: bold;">0 valgte</span>
                </div>

                <!-- Add/Edit Question Form -->
                <div id="questionForm" style="display: none; margin-top: 20px;">
                    <form method="POST" action="{{ url_for('admin_dashboard') }}" id="newQuestionForm">
                        <h2>Legg til nytt sp√∏rsm√•l</h2>
                        <input type="hidden" name="question_id" id="questionId">
                        
                        <label for="question">Sp√∏rsm√•l:</label>
                        <textarea name="question" id="questionText" required></textarea>

                        <label for="option_a">Alternativ A:</label>
                        <input type="text" name="option_a" id="optionA" required>

                        <label for="option_b">Alternativ B:</label>
                        <input type="text" name="option_b" id="optionB" required>

                        <label for="option_c">Alternativ C:</label>
                        <input type="text" name="option_c" id="optionC" required>

                        <label for="option_d">Alternativ D:</label>
                        <input type="text" name="option_d" id="optionD" required>

                        <label for="correct_answer">Riktig svar (a, b, c, d):</label>
                        <input type="text" name="correct_answer" id="correctAnswer" maxlength="1" pattern="[a-dA-D]" required>

                        <label for="category">Kategori:</label>
                        <input type="text" name="category" id="categoryInput">

                        <label for="image_filename">Velg bilde:</label>
                        <select name="image_filename" id="imageSelect">
                            <option value="">Ingen bilde</option>
                            {% for image in images %}
                            <option value="{{ image.filename }}">{{ image.name }} ({{ image.filename }})</option>
                            {% endfor %}
                        </select>

                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button type="submit">‚ûï Lagre sp√∏rsm√•l</button>
                            <button type="button" onclick="previewQuestion()" class="btn btn-warning">üëÅÔ∏è Forh√•ndsvis</button>
                            <button type="button" onclick="cancelForm()" class="btn" style="background-color: #6c757d;">Avbryt</button>
                        </div>
                    </form>
                </div>

                <!-- Questions Table -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th class="checkbox-column bulk-checkbox" style="display: none;">
                                    <input type="checkbox" onchange="toggleAllCheckboxes(this)">
                                </th>
                                <th>ID</th>
                                <th>Sp√∏rsm√•l</th>
                                <th>Kategori</th>
                                <th>Bilde</th>
                                <th>Alternativer</th>
                                <th>Handlinger</th>
                            </tr>
                        </thead>
                        <tbody id="questionsTableBody">
                            {% for question in questions %}
                            <tr data-id="{{ question.id }}">
                                <td class="checkbox-column bulk-checkbox" style="display: none;">
                                    <input type="checkbox" name="question_ids" value="{{ question.id }}" onchange="updateSelectedCount()">
                                </td>
                                <td>{{ question.id }}</td>
                                <td>{{ question.question }}</td>
                                <td>{{ question.category or 'Ukategorisert' }}</td>
                                <td>
                                    {% if question.image_filename %}
                                    <img src="{{ url_for('static', filename='images/signs/' ~ question.image_filename) }}" 
                                         alt="{{ question.image_filename }}" class="question-image">
                                    {% else %}
                                    <span style="color: #999;">Ingen bilde</span>
                                    {% endif %}
                                </td>
                                <td class="options-display">
                                    <div>A: {{ question.option_a }}</div>
                                    <div>B: {{ question.option_b }}</div>
                                    <div>C: {{ question.option_c }}</div>
                                    <div>D: {{ question.option_d }}</div>
                                    <div class="correct-answer">Riktig: {{ question.correct_option|upper }}</div>
                                </td>
                                <td>
                                    <button type="button" onclick="editQuestionFromRow(this, {{ question.id }})" class="btn btn-warning btn-small">‚úèÔ∏è Rediger</button>
                                    <button type="button" onclick="confirmDelete({{ question.id }})" class="btn btn-danger btn-small">üóëÔ∏è Slett</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>

        <script>
        // editQuestionFromRow moved from <style> to here
        function editQuestionFromRow(button, id) {
            console.log('Edit button clicked for ID:', id);
            
            try {
                // Get the row from the button
                const row = button.closest('tr');
                if (!row) {
                    console.error('Row not found');
                    alert('Kunne ikke finne sp√∏rsm√•let.');
                    return;
                }
                
                // Show the form first
                document.getElementById('questionForm').style.display = 'block';
                document.getElementById('newQuestionForm').querySelector('h2').textContent = 'Rediger sp√∏rsm√•l';
                document.getElementById('questionId').value = id;
                
                // Get the cells
                const cells = row.cells;
                
                // Check if bulk mode is active by looking at the first cell
                let startIndex = 0;
                if (cells[0] && cells[0].querySelector('input[type="checkbox"]')) {
                    startIndex = 1; // Skip checkbox column
                }
                
                // Extract data based on position
                const questionText = cells[startIndex + 1].textContent.trim(); // Skip ID column
                const categoryText = cells[startIndex + 2].textContent.trim();
                const imageCell = cells[startIndex + 3];
                const optionsCell = cells[startIndex + 4];
                
                // Fill form fields
                document.getElementById('questionText').value = questionText;
                document.getElementById('categoryInput').value = categoryText === 'Ukategorisert' ? '' : categoryText;
                
                // Extract options
                if (optionsCell) {
                    const optionDivs = optionsCell.querySelectorAll('div');
                    optionDivs.forEach(div => {
                        const text = div.textContent.trim();
                        if (text.startsWith('A:')) {
                            document.getElementById('optionA').value = text.substring(2).trim();
                        } else if (text.startsWith('B:')) {
                            document.getElementById('optionB').value = text.substring(2).trim();
                        } else if (text.startsWith('C:')) {
                            document.getElementById('optionC').value = text.substring(2).trim();
                        } else if (text.startsWith('D:')) {
                            document.getElementById('optionD').value = text.substring(2).trim();
                        } else if (text.includes('Riktig:')) {
                            document.getElementById('correctAnswer').value = text.split(':')[1].trim().toLowerCase();
                        }
                    });
                }
                
                // Handle image
                if (imageCell) {
                    const img = imageCell.querySelector('img');
                    if (img) {
                        const src = img.getAttribute('src');
                        const filename = src.split('/').pop();
                        document.getElementById('imageSelect').value = filename;
                    } else {
                        document.getElementById('imageSelect').value = '';
                    }
                }
                
                // Scroll to form
                document.getElementById('questionForm').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error in editQuestionFromRow:', error);
                alert('Det oppstod en feil. Sjekk konsollen for detaljer.');
            }
        }
        </script>

        <!-- Database Section -->
        <div id="databaseSection" class="section" style="margin-top: 30px;">
            <h2>Database Administrasjon</h2>
            
            <!-- Database Statistics -->
            <div class="db-stats-container">
                <div class="db-stat-card">
                    <h3>{{ tables|length }}</h3>
                    <p>Totale tabeller</p>
                </div>
                <div class="db-stat-card">
                    <h3>{{ stats.total }}</h3>
                    <p>Totale sp√∏rsm√•l</p>
                </div>
                <div class="db-stat-card">
                    <h3>{{ images|length }}</h3>
                    <p>Tilgjengelige bilder</p>
                </div>
            </div>

            <!-- SQL Console -->
            <div class="sql-console">
                <h3>üíª SQL-konsoll</h3>
                <form method="POST" action="{{ url_for('admin_dashboard') }}">
                    <textarea name="sql_query" placeholder="Skriv inn SQL-sp√∏rring her..." rows="5"></textarea>
                    <button type="submit" class="btn" style="margin-top: 10px;">‚ñ∂Ô∏è Kj√∏r SQL</button>
                </form>
                {% if message %}
                <div class="sql-result">
                    {{ message }}
                </div>
                {% endif %}
            </div>

            <!-- Table Filter -->
            <div class="table-filter-bar">
                <label for="tableFilter">üìä Vis tabell:</label>
                <select id="tableFilter" onchange="filterTables()">
                    <option value="all">Alle tabeller</option>
                    {% for table in tables.keys() %}
                    <option value="{{ table }}">{{ table }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Tables Display -->
            {% for table, rows in tables.items() %}
            <div class="table-section" data-table="{{ table }}">
                <h3>{{ table|upper|replace('_', ' ') }}</h3>
                
                {% if rows %}
                    <!-- Column Filter -->
                    <div class="column-filter">
                        <strong>Vis kolonner:</strong>
                        {% for col in rows[0].keys() %}
                        <label>
                            <input type="checkbox" 
                                   class="column-checkbox" 
                                   data-table="{{ table }}" 
                                   data-column="{{ col }}" 
                                   checked> {{ col }}
                        </label>
                        {% endfor %}
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    {% for col in rows[0].keys() %}
                                    <th data-column="{{ col }}">
                                        {{ col }}
                                        <select class="column-value-filter" 
                                                data-table="{{ table }}" 
                                                data-column="{{ col }}" 
                                                onchange="filterTableByColumn()">
                                            <option value="all">Alle</option>
                                            {% set unique_values = [] %}
                                            {% for row in rows %}
                                                {% if row[col] not in unique_values %}
                                                    {% set _ = unique_values.append(row[col]) %}
                                                {% endif %}
                                            {% endfor %}
                                            {% for value in unique_values %}
                                            <option value="{{ value }}">{{ value }}</option>
                                            {% endfor %}
                                        </select>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in rows %}
                                <tr>
                                    {% for col in rows[0].keys() %}
                                    <td data-column="{{ col }}">
                                        {% if table == 'traffic_signs' and col == 'filename' and row[col] %}
                                        <img src="{{ url_for('static', filename='images/signs/' ~ row[col]) }}" 
                                             alt="{{ row[col] }}" 
                                             style="max-width: 100px; height: auto;">
                                        {% else %}
                                        {{ row[col] or '-' }}
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p style="color: #999; font-style: italic;">Ingen data i denne tabellen.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Preview Modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePreview()">&times;</span>
            <h2>üëÅÔ∏è Forh√•ndsvisning av sp√∏rsm√•l</h2>
            <div id="previewContent"></div>
        </div>
    </div>

    <script>
        // Section management
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(sectionName + 'Section').classList.add('active');
            document.getElementById(sectionName + 'Tab').classList.add('active');
        }

        // Form management
        function toggleForm() {
            const form = document.getElementById('questionForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
            
            if (form.style.display === 'block') {
                document.getElementById('questionText').focus();
                document.getElementById('newQuestionForm').querySelector('h2').textContent = 'Legg til nytt sp√∏rsm√•l';
                document.getElementById('questionId').value = '';
                document.getElementById('newQuestionForm').reset();
            }
        }

        function cancelForm() {
            document.getElementById('questionForm').style.display = 'none';
            document.getElementById('newQuestionForm').reset();
            document.getElementById('questionId').value = '';
        }

        // Bulk operations
        let bulkModeEnabled = false;
        
        function toggleBulkMode() {
            bulkModeEnabled = !bulkModeEnabled;
            const bulkOperations = document.getElementById('bulkOperations');
            const bulkCheckboxes = document.querySelectorAll('.bulk-checkbox');
            const bulkModeBtn = document.getElementById('bulkModeBtn');
            
            if (bulkModeEnabled) {
                bulkOperations.style.display = 'block';
                bulkCheckboxes.forEach(cb => cb.style.display = 'table-cell');
                bulkModeBtn.textContent = '‚ùå Avbryt bulk-modus';
                bulkModeBtn.classList.remove('btn-warning');
                bulkModeBtn.classList.add('btn-danger');
            } else {
                bulkOperations.style.display = 'none';
                bulkCheckboxes.forEach(cb => cb.style.display = 'none');
                bulkModeBtn.textContent = '‚úÖ Bulk-operasjoner';
                bulkModeBtn.classList.remove('btn-danger');
                bulkModeBtn.classList.add('btn-warning');
                deselectAllQuestions();
            }
        }

        function selectAllQuestions() {
            document.querySelectorAll('input[name="question_ids"]').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount();
        }

        function deselectAllQuestions() {
            document.querySelectorAll('input[name="question_ids"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }

        function toggleAllCheckboxes(masterCheckbox) {
            document.querySelectorAll('input[name="question_ids"]').forEach(checkbox => {
                checkbox.checked = masterCheckbox.checked;
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const selectedCheckboxes = document.querySelectorAll('input[name="question_ids"]:checked');
            document.getElementById('selectedCount').textContent = selectedCheckboxes.length + ' valgte';
        }

        function confirmBulkDelete() {
            const selectedCount = document.querySelectorAll('input[name="question_ids"]:checked').length;
            if (selectedCount === 0) {
                alert('Ingen sp√∏rsm√•l er valgt for sletting.');
                return false;
            }
            return confirm(`Er du sikker p√• at du vil slette ${selectedCount} sp√∏rsm√•l? Dette kan ikke angres.`);
        }

        // Delete confirmation
        function confirmDelete(id) {
            if (confirm('Er du sikker p√• at du vil slette dette sp√∏rsm√•let?')) {
                // Create a form and submit it
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = `/admin/delete_question/${id}`;
                document.body.appendChild(form);
                form.submit();
            }
        }

        // Edit question with debugging
        function editQuestion(id) {
            console.log('Edit button clicked for ID:', id);
            
            try {
                // Find the question data from the table row
                const row = document.querySelector(`tr[data-id="${id}"]`);
                if (!row) {
                    console.error('Row not found for ID:', id);
                    alert('Kunne ikke finne sp√∏rsm√•let. Pr√∏v √• laste siden p√• nytt.');
                    return;
                }
                
                // Show the form first
                document.getElementById('questionForm').style.display = 'block';
                document.getElementById('newQuestionForm').querySelector('h2').textContent = 'Rediger sp√∏rsm√•l';
                document.getElementById('questionId').value = id;
                
                // Get the cells - adjust based on actual structure
                const cells = row.cells;
                console.log('Number of cells:', cells.length);
                
                // Find the index of each cell type by checking content
                let questionIndex = -1, categoryIndex = -1, optionsIndex = -1, imageIndex = -1;
                
                for (let i = 0; i < cells.length; i++) {
                    const cellText = cells[i].textContent.trim();
                    const cellHTML = cells[i].innerHTML;
                    
                    // Skip if it's the ID cell
                    if (cellText === id.toString()) continue;
                    
                    // Check if it's the options cell (contains "A:", "B:", etc.)
                    if (cellHTML.includes('A:') && cellHTML.includes('B:')) {
                        optionsIndex = i;
                    }
                    // Check if it's the image cell
                    else if (cellHTML.includes('<img') || cellText === 'Ingen bilde') {
                        imageIndex = i;
                    }
                    // Check if it's the actions cell (contains buttons)
                    else if (cellHTML.includes('Rediger') || cellHTML.includes('Slett')) {
                        // Skip actions cell
                    }
                    // Check if it's category (common categories)
                    else if (cellText === 'Ukategorisert' || cellText === 'Fartsgrenser' || cellText === 'Trafikkregler' || cellText === 'Sikkerhetsutstyr') {
                        categoryIndex = i;
                    }
                    // Otherwise, if it's a longer text and we haven't found question yet, it's probably the question
                    else if (cellText.length > 20 && questionIndex === -1) {
                        questionIndex = i;
                    }
                }
                
                console.log('Found indices - Question:', questionIndex, 'Category:', categoryIndex, 'Options:', optionsIndex);
                
                // Fill question text
                if (questionIndex !== -1) {
                    document.getElementById('questionText').value = cells[questionIndex].textContent.trim();
                }
                
                // Fill category
                if (categoryIndex !== -1) {
                    const categoryText = cells[categoryIndex].textContent.trim();
                    document.getElementById('categoryInput').value = categoryText === 'Ukategorisert' ? '' : categoryText;
                }
                
                // Fill options
                if (optionsIndex !== -1) {
                    const optionsDiv = cells[optionsIndex];
                    const optionLines = optionsDiv.innerText.split('\n').filter(line => line.trim());
                    
                    optionLines.forEach(line => {
                        if (line.startsWith('A:')) {
                            document.getElementById('optionA').value = line.substring(2).trim();
                        } else if (line.startsWith('B:')) {
                            document.getElementById('optionB').value = line.substring(2).trim();
                        } else if (line.startsWith('C:')) {
                            document.getElementById('optionC').value = line.substring(2).trim();
                        } else if (line.startsWith('D:')) {
                            document.getElementById('optionD').value = line.substring(2).trim();
                        } else if (line.includes('Riktig:')) {
                            const correctAnswer = line.split(':')[1].trim().toLowerCase();
                            document.getElementById('correctAnswer').value = correctAnswer;
                        }
                    });
                }
                
                // Handle image
                if (imageIndex !== -1) {
                    const imageCell = cells[imageIndex];
                    const imageImg = imageCell.querySelector('img');
                    if (imageImg) {
                        const imageSrc = imageImg.getAttribute('src');
                        const filename = imageSrc.split('/').pop();
                        document.getElementById('imageSelect').value = filename;
                    } else {
                        document.getElementById('imageSelect').value = '';
                    }
                }
                
                // Scroll to form
                document.getElementById('questionForm').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error in editQuestion:', error);
                alert('Det oppstod en feil ved redigering. Se konsollen for detaljer.');
            }
        }

        // Preview question
        function previewQuestion() {
            const question = document.getElementById('questionText').value;
            const optionA = document.getElementById('optionA').value;
            const optionB = document.getElementById('optionB').value;
            const optionC = document.getElementById('optionC').value;
            const optionD = document.getElementById('optionD').value;
            const correctAnswer = document.getElementById('correctAnswer').value.toLowerCase();
            const imageSelect = document.getElementById('imageSelect');
            const imageName = imageSelect.options[imageSelect.selectedIndex].text;
            
            let previewHTML = '<div class="preview-question">';
            
            if (imageSelect.value) {
                previewHTML += `<img src="/static/images/signs/${imageSelect.value}" style="max-width: 200px; margin-bottom: 15px;">`;
            }
            
            previewHTML += `<h3>${question || 'Sp√∏rsm√•lstekst kommer her...'}</h3>`;
            previewHTML += '<div class="preview-options">';
            previewHTML += `<div class="preview-option ${correctAnswer === 'a' ? 'correct' : ''}">A: ${optionA || 'Alternativ A'}</div>`;
            previewHTML += `<div class="preview-option ${correctAnswer === 'b' ? 'correct' : ''}">B: ${optionB || 'Alternativ B'}</div>`;
            previewHTML += `<div class="preview-option ${correctAnswer === 'c' ? 'correct' : ''}">C: ${optionC || 'Alternativ C'}</div>`;
            previewHTML += `<div class="preview-option ${correctAnswer === 'd' ? 'correct' : ''}">D: ${optionD || 'Alternativ D'}</div>`;
            previewHTML += '</div></div>';
            
            document.getElementById('previewContent').innerHTML = previewHTML;
            document.getElementById('previewModal').style.display = 'block';
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // Database section functions
        function filterTables() {
            const selectedTable = document.getElementById('tableFilter').value;
            const tables = document.querySelectorAll('.table-section');
            
            tables.forEach(table => {
                if (selectedTable === 'all' || table.dataset.table === selectedTable) {
                    table.style.display = 'block';
                } else {
                    table.style.display = 'none';
                }
            });
        }

        // Column visibility toggle
        document.querySelectorAll('.column-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const table = this.dataset.table;
                const column = this.dataset.column;
                const cells = document.querySelectorAll(`.table-section[data-table="${table}"] [data-column="${column}"]`);
                
                cells.forEach(cell => {
                    cell.style.display = this.checked ? '' : 'none';
                });
            });
        });

        // Column value filtering
        function filterTableByColumn() {
            const tables = document.querySelectorAll('.table-section');
            
            tables.forEach(table => {
                const rows = table.querySelectorAll('tbody tr');
                const filters = table.querySelectorAll('.column-value-filter');
                
                rows.forEach(row => {
                    let showRow = true;
                    
                    filters.forEach(filter => {
                        const column = filter.dataset.column;
                        const filterValue = filter.value;
                        const cell = row.querySelector(`td[data-column="${column}"]`);
                        
                        if (filterValue !== 'all' && cell && cell.textContent.trim() !== filterValue) {
                            showRow = false;
                        }
                    });
                    
                    row.style.display = showRow ? '' : 'none';
                });
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>