project:
  name: Driving Theory Platform
  purpose: Modern, all-in-one web/mobile app that helps users
    pass the driver’s theory test through quizzes, videos,
    games, progress tracking and gamification in Norway.
  features:
    quizzes:
      - interactive
      - categorized (road signs, traffic rules)
      - detailed explanations
      - images
    multimedia:
      - instructional videos
      - simulated driving scenarios
    progress_tracking:
      - personalized analytics
    gamification:
      - achievements
      - daily streaks
      - leaderboards

tech_stack:
  backend:
    framework: Flask
    database: MySQL
    orm: SQLAlchemy
    cache: Redis
    tasks: Celery
    ml_stack:
      - scikit-learn # Local machine learning algorithms
      - pandas       # Data analysis and manipulation
      - numpy        # Numerical computing
      - scipy        # Scientific computing
  frontend:
    ui_library: React components with Tailwind CSS
    css_framework: Tailwind CSS
    charts: Chart.js
    games: Phaser.js
  mobile:
    framework: Progressive Web App (PWA)
  infrastructure:
    containers: Docker
    storage: Local file system + AWS S3
    ci_cd: GitHub Actions
    ml_privacy: Local processing (no external APIs)
    testing: pytest with database isolation
    caching: Redis with fallback mechanisms
    monitoring: Centralized error logging
    deployment: Branch-based strategy (develop/main)

database:
  tables:
      traffic_signs:   
      - id
      - sign_code
      - category
      - filename
      - description
      - explanation
    options:  
      - id
      - question_id
      - option_letter   # 'a', 'b', 'c', 'd'
      - option_text
    users:
      - id
      - username
      - email
      - password_hash
      - full_name
      - date_of_birth
      - created_at
      - last_login
      - is_active
      - profile_picture
      - preferred_language
      - total_xp
      - is_verified
      - subscription_tier          # DEPRECATED - kept for backward compatibility
      - current_plan_id            # FK → subscription_plans.id (NEW - single source of truth)
      - subscription_status        # ENUM('active', 'cancelled', 'expired', 'trial')
      - is_admin
    user_progress:
      - id
      - user_id
      - total_quizzes_taken
      - total_questions_answered
      - correct_answers
      - total_game_sessions
      - total_game_score
      - total_videos_watched
      - videos_completed
      - current_streak_days
      - longest_streak_days
      - last_activity_date
    achievements:
      - id
      - name
      - description
      - icon_filename
      - points
      - category
      - requirement_type
      - requirement_value
    user_achievements:
      - id
      - user_id
      - achievement_id
      - earned_at
    questions:
      - id
      - question
      - correct_option
      - category
      - subcategory
      - difficulty_level
      - explanation
      - image_filename
      - created_at
      - updated_at
      - is_active
      - question_type
    options:
      - id
      - question_id
      - option_letter
      - option_text
    question_images:
      - question_id
      - image_id
      - role
    quiz_images:
      - id
      - filename
      - folder
      - title
      - description
      - uploaded_at
      - uploader_id
      - tags
    quiz_sessions:
      - id
      - user_id
      - quiz_type
      - category
      - total_questions
      - correct_answers
      - time_spent_seconds
      - score
      - started_at
      - completed_at
    quiz_responses:
      - id
      - session_id
      - question_id
      - user_answer
      - is_correct
      - time_spent_seconds
    game_scenarios:
      - id
      - name
      - description
      - scenario_type   # 'traffic_signs', 'driving_sim', 'memory', 'puzzle', 'time_challenge', 'multiplayer'
      - difficulty_level
      - max_score
      - time_limit_seconds
      - config_json
      - template_name   # Template file name for the game
      - is_active
      - order_index
      - min_level_required   # Minimum user level to play
      - is_premium   # Premium-only game
    game_sessions:
      - id
      - user_id
      - scenario_id
      - score
      - time_played_seconds
      - mistakes_count
      - completed
      - started_at
      - completed_at
    videos:
      - id
      - title
      - description
      - filename
      - youtube_url
      - duration_seconds
      - category
      - category_id
      - difficulty_level
      - order_index
      - thumbnail_filename
      - created_at
      - is_active
      - view_count
    video_checkpoints:
      - id
      - video_id
      - timestamp_seconds
      - question_id
      - is_mandatory
    video_progress:
      - id
      - user_id
      - video_id
      - last_position_seconds
      - completed
      - checkpoints_passed
      - total_checkpoints
      - started_at
      - completed_at
      - updated_at
    learning_paths:
      - id
      - name
      - description
      - estimated_hours
      - difficulty_level
      - icon_filename
      - is_recommended
    learning_path_items:
      - id
      - path_id
      - item_type
      - item_id
      - order_index
      - is_mandatory
    user_learning_paths:
      - id
      - user_id
      - path_id
      - progress_percentage
      - started_at
      - completed_at
    video_categories:
      - id
      - name
      - description
      - icon
      - order_index
    video_playlists:
      - id
      - name
      - description  
      - thumbnail_url
      - is_official
      - created_by
      - created_at
      - updated_at
    playlist_items:
      - id
      - playlist_id
      - video_id
      - order_index
      - added_at
    video_notes:
      - id
      - user_id
      - video_id
      - timestamp_seconds
      - note_text
      - created_at
      - updated_at
    video_subtitles:
      - id
      - video_id
      - language_code
      - subtitle_file
      - is_auto_generated
      - created_at
    video_ratings:
      - id
      - user_id
      - video_id
      - rating
      - created_at
    video_bookmarks:
      - id
      - user_id
      - video_id
      - created_at
    leaderboard_entries:
      - id
      - user_id
      - leaderboard_type
      - category
      - score
      - rank
      - period_start
      - period_end
      - created_at
    subscription_plans:
      - id
      - name                       # 'free', 'premium', 'pro'
      - display_name               # 'Premium Plan'
      - price_nok                  # Price in NOK
      - billing_cycle              # 'monthly', 'yearly'
      - description
      - features_json              # JSON list of features
      - max_daily_quizzes          # null = unlimited
      - max_weekly_exams           # null = unlimited
      - has_ads
      - has_detailed_stats
      - has_ai_adaptive
      - has_offline_mode
      - has_personal_tutor
      - has_video_access
      - priority_support
      - is_active
      - created_at
    user_feedback:
      - id
      - user_id
      - feedback_type
      - subject
      - message
      - status
      - created_at
    admin_reports:
      - id
      - report_type
      - priority
      - status
      - title
      - description
      - reported_by_user_id
      - affected_user_id
      - ip_address
      - created_at
      - resolved_at
    user_subscriptions:
      - id
      - user_id                    # FK → users.id
      - plan_id                    # FK → subscription_plans.id
      - status                     # 'active', 'cancelled', 'expired', 'pending'
      - started_at
      - expires_at
      - cancelled_at
      - auto_renew
      - next_billing_date
      - stripe_subscription_id
      - payment_method_id
      - is_trial
      - trial_ends_at
      - cancelled_reason
      - notes
      - created_at
      - updated_at
    user_notification_preferences:
      - id
      - user_id                    # FK → users.id
      - daily_reminders            # BOOLEAN DEFAULT TRUE
      - weekly_summary             # BOOLEAN DEFAULT TRUE
      - achievement_notifications  # BOOLEAN DEFAULT TRUE
      - streak_lost_reminders      # BOOLEAN DEFAULT TRUE
      - study_tips                 # BOOLEAN DEFAULT TRUE
      - new_features               # BOOLEAN DEFAULT TRUE
      - progress_milestones        # BOOLEAN DEFAULT TRUE
      - quiz_reminder_frequency    # VARCHAR(20) DEFAULT 'daily' ('never', 'daily', 'weekly')
      - marketing_emails           # BOOLEAN DEFAULT FALSE
      - partner_offers             # BOOLEAN DEFAULT FALSE
      - reminder_time              # TIME DEFAULT '18:00:00'
      - timezone                   # VARCHAR(50) DEFAULT 'Europe/Oslo'
      - created_at
      - updated_at
    payments:
      - id
      - user_id                    # FK → users.id
      - subscription_id            # FK → user_subscriptions.id
      - plan_id                    # FK → subscription_plans.id
      - amount_nok
      - currency
      - status                     # 'pending', 'completed', 'failed', 'refunded'
      - payment_method             # 'card', 'vipps', 'bank_transfer'
      - stripe_payment_intent_id
      - stripe_charge_id
      - vipps_transaction_id
      - invoice_number
      - invoice_pdf_path
      - billing_name
      - billing_email
      - billing_address
      - payment_date
      - failure_reason
      - description
      - created_at
      - updated_at
    usage_limits:
      - id
      - user_id                    # FK → users.id
      - daily_quizzes_taken
      - daily_limit_date
      - weekly_exams_taken
      - weekly_limit_start
      - monthly_videos_watched
      - created_at
      - updated_at
    discount_codes:
      - id
      - code
      - description
      - discount_type              # 'percentage', 'fixed_amount', 'free_trial'
      - discount_value
      - valid_from
      - valid_until
      - max_uses
      - current_uses
      - is_active
      - created_at
    # ML-POWERED PERSONALIZATION TABLES
    user_skill_profiles:
      - id
      - user_id                    # FK → users.id
      - category                   # e.g., 'traffic_signs', 'road_rules'
      - subcategory                # More specific areas (optional)
      - accuracy_score             # FLOAT (0.0-1.0) Historical accuracy
      - confidence_score           # FLOAT (0.0-1.0) User confidence level
      - learning_rate              # FLOAT (0.0-1.0) Speed of improvement
      - difficulty_preference      # FLOAT (0.0-1.0) Preferred difficulty
      - avg_response_time          # FLOAT Average time per question (seconds)
      - response_time_variance     # FLOAT Consistency of response times
      - questions_attempted        # INT Total questions in this category
      - questions_correct          # INT Correct answers in this category
      - last_updated               # DATETIME When profile was last updated
    question_difficulty_profiles:
      - id
      - question_id                # FK → questions.id
      - computed_difficulty        # FLOAT (0.0-1.0) ML-computed difficulty
      - discrimination_power       # FLOAT (0.0-1.0) How well it separates skill levels
      - guess_factor              # FLOAT (0.0-1.0) Probability of guessing correctly
      - total_attempts            # INT Number of times attempted
      - correct_attempts          # INT Number of correct attempts
      - avg_response_time         # FLOAT Average time spent on this question
      - response_time_variance    # FLOAT Variance in response times
      - skill_threshold           # FLOAT Min skill needed for >50% success
      - learning_value            # FLOAT How much this question teaches
      - last_updated              # DATETIME When profile was last updated
    adaptive_quiz_sessions:
      - id
      - user_id                   # FK → users.id
      - quiz_session_id           # FK → quiz_sessions.id
      - algorithm_version         # VARCHAR(50) ML algorithm version used
      - target_difficulty         # FLOAT (0.0-1.0) Target difficulty level
      - adaptation_strength       # FLOAT How aggressively to adapt
      - initial_skill_estimate    # FLOAT Estimated skill at session start
      - final_skill_estimate      # FLOAT Estimated skill at session end
      - skill_improvement         # FLOAT Measured improvement during session
      - questions_above_skill     # INT Questions too difficult
      - questions_below_skill     # INT Questions too easy
      - questions_optimal         # INT Questions at appropriate level
      - average_engagement_score  # FLOAT Based on response patterns
      - frustration_indicators    # INT Count of frustration signs
      - confidence_trend          # VARCHAR(20) 'improving', 'declining', 'stable'
      - created_at                # DATETIME Session creation time
    learning_analytics:
      - id
      - user_id                   # FK → users.id
      - date                      # DATE Analytics for specific date
      - total_study_time_minutes  # INT Total study time for the day
      - questions_attempted       # INT Questions attempted on this date
      - questions_correct         # INT Correct answers on this date
      - average_difficulty_attempted # FLOAT Average difficulty of questions
      - avg_response_time         # FLOAT Average response time
      - response_time_consistency # FLOAT Lower = more consistent
      - mistakes_per_session      # FLOAT Average mistakes per session
      - learning_velocity         # FLOAT Rate of skill improvement
      - knowledge_retention       # FLOAT How well knowledge is retained
      - concept_mastery_score     # FLOAT Overall concept understanding
      - preferred_study_duration  # INT Minutes per session preference
      - optimal_question_difficulty # FLOAT User's optimal difficulty level
      - learning_style_indicators # TEXT JSON with learning style data
      - weakest_categories        # TEXT JSON array of weak categories
      - strength_categories       # TEXT JSON array of strong categories
      - recommended_study_time    # INT Suggested minutes for next session
      - recommended_difficulty    # FLOAT Suggested difficulty level
      - priority_topics           # TEXT JSON array of topics to focus on
      - created_at                # DATETIME Record creation time
    ml_models:
      - id
      - name                      # VARCHAR(100) Model name (e.g., 'difficulty_predictor')
      - version                   # VARCHAR(50) Model version
      - description               # TEXT Model description
      - accuracy_score            # FLOAT Model accuracy metric
      - precision_score           # FLOAT Model precision metric
      - recall_score              # FLOAT Model recall metric
      - f1_score                  # FLOAT Model F1 metric
      - hyperparameters           # TEXT JSON with model settings
      - feature_importance        # TEXT JSON with feature weights
      - is_active                 # BOOLEAN Whether model is active
      - total_predictions         # INT Number of predictions made
      - last_retrained            # DATETIME When model was last retrained
      - created_at                # DATETIME Model creation time
      - created_by                # INT FK → users.id (who created the model)
    enhanced_quiz_responses:
      - id
      - quiz_response_id          # FK → quiz_responses.id
      - user_confidence_level     # FLOAT User's confidence in their answer
      - difficulty_perception     # FLOAT How hard user thought question was
      - cognitive_load_score      # FLOAT Estimated mental effort required
      - time_to_first_answer      # FLOAT Time before first option selected
      - answer_change_count       # INT How many times user changed answer
      - hesitation_score          # FLOAT Measure of uncertainty
      - question_order_in_session # INT Position of question in quiz
      - user_fatigue_score        # FLOAT Estimated tiredness level
      - predicted_difficulty      # FLOAT ML prediction before answer
      - actual_difficulty         # FLOAT Calculated difficulty after answer
      - knowledge_gain_estimate   # FLOAT How much user learned
      - skill_level_before        # FLOAT Estimated skill before question
      - skill_level_after         # FLOAT Estimated skill after question
      - created_at                # DATETIME Response creation time

file_structure:
  root:
    - app.py
    - config.py
    - requirements.txt
    - run.py
    - .env
    - README.md
    app:
      - auth
      - main
      - quiz
      - game   # Interactive games module (Phase 9)
      - video
      - admin
      - api
      - ml     # Machine Learning module (Phase 12)
      - utils
      - models.py
      - gamification_models.py
      - video_models.py
      - payment_models.py
      - notification_models.py
    static:
      css: [main.css, quiz.css, game.css, video.css, admin.css, ml.css]
      js: [main.js, quiz.js, game scripts, video-player.js, admin.js, ml-insights.js]
      images: [signs, scenarios, achievements, ui, profiles]
      videos: []
      audio: []
    templates:
      - auth
        - login.html
        - register.html
        - profile.html
        - change_password.html
        - notification_settings.html
      - quiz
      - game   # Game templates (traffic_signs, memory_game, etc.)
      - video
      - progress
      - admin
      - ml     # ML templates (insights.html, learning_dashboard.html, etc.)
      - components
      - emails
        - verify_email.html
        - welcome_email.html
        - daily_reminder.html
        - weekly_summary.html
        - badge_earned.html
        - study_tip.html
        - (and 7 more email types)
    migrations: []
    tests: [test_auth.py, test_basic.py, test_models.py, conftest.py]
    scripts: [init_db.py, import_questions.py, generate_stats.py, init_ml.py]
    ci_cd:
      - .github/workflows/ci.yml
      - .pre-commit-config.yaml
      - Dockerfile
      - docker-compose.yml
    errors:
      - app/errors.py
      - templates/errors/404.html
      - templates/errors/500.html
    services:
      - app/services/cache_service.py

security:
  storage: ".env"
  items:
    - SECRET_KEY
    - DATABASE_URL
    - REDIS_URL
    - JWT_SECRET
  authentication:
    hashing: bcrypt
    session_management: true
    csrf_protection: true
  data_protection:
    input_validation: true
    sql_injection_protection: true
    xss_protection: true
  compliance: GDPR
  ci_cd_security:
    vulnerability_scanning: Trivy, bandit, safety
    code_quality: black, flake8, isort, mypy
    test_isolation: In-memory SQLite database
    error_tracking: Centralized logging via AdminReport
    branch_protection: Automated testing on PR/push

monetization:
  model: Ad-supported Freemium
  description: >
    The platform is free by default and monetized via ads. Users can optionally upgrade
    to remove ads and unlock additional features.
  subscription_tiers:
    free:
      access: limited daily quizzes, 2 mock exam/week (45 question multiple choice, max 7 mistakes to pass), basic stats
      ads: enabled
    premium:
      access: unlimited quizzes, videos, detailed stats, AI-adaptive learning
      ads: disabled
      price: 149 NOK/month
    pro:
      access: everything in premium + offline mode, personal tutor
      ads: disabled
      price: 249 NOK/month

future_enhancements:
  phase_13_advanced_ml:
    description: "Advanced ML features for next-generation personalization"
    features:
      - advanced_learning_styles: "Visual, auditory, kinesthetic adaptation"
      - predictive_analytics: "Forecast user success probability on exam"
      - collaborative_filtering: "Learn from similar users' learning patterns"
      - advanced_nlp: "Question content analysis for better categorization"
      - real_time_adaptation: "Within-session difficulty adjustment"
      - emotional_intelligence: "Detect frustration and adjust accordingly"
      - multi_modal_learning: "Combine quiz, video, and game data"
  
  phase_14_ai_tutoring:
    description: "AI-powered personal tutoring system"
    features:
      - conversational_ai: "Natural language explanations and help"
      - personalized_explanations: "Adaptive explanations based on user understanding"
      - study_planning: "Automated study schedule optimization"
      - weakness_remediation: "Targeted remedial content generation"
      - exam_preparation: "AI-powered exam readiness assessment"
      - progress_prediction: "Predict time to exam readiness"
  
  phase_15_social_learning:
    description: "Community-driven learning with ML insights"
    features:
      - peer_matching: "Connect users with similar learning patterns"
      - group_challenges: "ML-optimized group study sessions"
      - knowledge_sharing: "AI-curated user-generated content"
      - instructor_insights: "Teacher dashboard with ML student analytics"
      - collaborative_filtering: "Learn from collective user behavior"
      - social_gamification: "ML-powered social achievements"
  
  phase_16_advanced_analytics:
    description: "Deep learning analytics and insights"
    features:
      - learning_pattern_analysis: "Deep learning pattern recognition"
      - concept_mapping: "AI-generated knowledge maps"
      - retention_optimization: "Spaced repetition with ML timing"
      - cognitive_load_management: "Optimize mental effort and fatigue"
      - skill_transfer_analysis: "Identify knowledge transfer between topics"
      - long_term_retention: "Predict and prevent knowledge decay"
  
  integration_opportunities:
    gamification_ml:
      - "ML-optimized achievement systems"
      - "Personalized challenge difficulty"
      - "Adaptive reward systems"
    
    video_learning_ml:
      - "Adaptive video recommendation"
      - "Optimal video checkpoint placement"
      - "Personalized video speed recommendations"
    
    mobile_optimization:
      - "Offline ML for PWA features"
      - "Edge computing for instant personalization"
      - "Mobile-specific learning pattern analysis"
    
    api_extensions:
      - "Third-party integration capabilities"
      - "Embeddable ML widgets"
      - "External learning system integration"
